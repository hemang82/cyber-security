"use client";

import { useTheme } from "@/context/ThemeContext";
import dynamic from "next/dynamic";
import React from "react";
import { ApexOptions } from "apexcharts";

const ReactApexChart = dynamic(() => import("react-apexcharts"), {
    ssr: false,
});

interface VulnerabilityChartProps {
    data: { severity: string; count: number; color?: string }[];
}

export const VulnerabilityChart: React.FC<VulnerabilityChartProps> = ({ data }) => {
    const { theme } = useTheme();

    // Color Mapping from text to hex
    const getColorHex = (severity: string) => {
        const s = severity.toLowerCase();
        if (s.includes("critical")) return "#ffc9c9"; // Dark Red
        if (s.includes("high")) return "#c3191d"; // Red
        if (s.includes("medium")) return "#feb273"; // Orange
        if (s.includes("low")) return "#ffdf20"; // Yellow
        return "#465fff"; // Info Blue
    };

    const series = data.map(d => d.count);
    const labels = data.map(d => d.severity);
    const colors = data.map(d => getColorHex(d.severity));

    const options: ApexOptions = {
        chart: {
            type: "donut",
        },
        labels: labels,
        colors: colors,
        legend: {
            position: "right",
            labels: {
                colors: theme === "dark" ? "#fff" : "#111",
            },
        },
        plotOptions: {
            pie: {
                donut: {
                    size: "65%",
                    labels: {
                        show: true,
                        total: {
                            show: true,
                            label: 'Total',
                            color: theme === "dark" ? "#fff" : "#111",
                        }
                    }
                }
            }
        },
        dataLabels: {
            enabled: false,
        },
        tooltip: {
            theme: theme === "dark" ? "dark" : "light",
        }
    };

    if (!data || data.length === 0) return null;

    return (
        <div className="flex items-center justify-center">
            <ReactApexChart options={options} series={series} type="donut" width={380} />
        </div>
    );
};
