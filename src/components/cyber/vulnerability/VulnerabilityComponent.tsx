"use client"

import { formatDate, safeText, TOAST_ERROR, TOAST_SUCCESS } from "@/common/commonFunction";
import { DATE_FORMAT } from "@/common/commonVariable";
import { CODES } from "@/common/constant";
import DynamicTable from "@/components/tables/DynamicTable";
import Pagination from "@/components/tables/Pagination";
import Badge from "@/components/ui/badge/Badge";
import { useRouter } from "next/navigation";
import React, { useEffect, useState } from "react";
import { IoMdRefresh } from "react-icons/io";
import { CyberColorClass, severityColor } from "../Inventory/assetsDetails/WebsiteDetails";
import { Modal } from "@/components/ui/modal";
import { useModal } from "@/hooks/useModal";
import { GoEye } from "react-icons/go";

// export const metadata: Metadata = {
//   title: "Next.js Basic Table | Cyber Admin - Next.js Dashboard Template",
//   description: "This is Next.js Basic Table  page for Cyber Admin  Tailwind CSS Admin Dashboard Template",
//   // other metadata
// };

export default function VulnerabilityComponent({ resVulnerabilityList, resDomainList }: any) {

    const { isOpen, openModal, closeModal, modalData } = useModal();

    const [vulnerability, setVulnerability] = useState(resVulnerabilityList);

    console.log('resVulnerabilityList', resVulnerabilityList);

    const router = useRouter();
    const [refreshingId, setRefreshingId] = useState<number | null>(null);

    const columns = [
        {
            key: "displayId",
            title: "Id",
        },
        {
            key: "asset_name",
            title: "Assets Name",
            render: (row: any) => (
                <span title={row.asset_name} className="block w-full max-w-[200px] truncate">
                    {row.asset_name}
                </span>
            ),
        },
        {
            key: "type",
            title: "Type",
            // render: (row: Order) => (
            //   <div className="flex items-center gap-3">
            //     <Image
            //       src={row.user.image}
            //       width={40}
            //       height={40}
            //       alt={row.user.name}
            //       className="rounded-full"
            //     />
            //     <div>
            //       <div className="font-medium text-gray-800 dark:text-white/90">
            //         {row.user.name}
            //       </div>
            //       <div className="text-xs text-gray-500">{row.user.role}</div>
            //     </div>
            //   </div>
            // ),
        },
        {
            key: "detail",
            title: "Detail",
            render: (row: any) => (
                // <div className="">
                //     <span className="inline-flex items-center justify-center rounded-full bg-brand-100 px-3 py-1 text-xs font-medium text-brand-600 dark:bg-gray-800 dark:text-gray-200">
                //         {row.txt_record}
                //     </span>
                // </div>
                <div title={safeText(row?.detail)} className="block w-full max-w-[300px] truncate">
                    {safeText(row?.detail)}
                </div>
            ),
        },
        {
            key: "serverity", title: "Serverity",
            render: (row: any) => (
                // <Badge size="sm" color={row.risk_level && severityColor(row.risk_level) || '12'}>
                //   {row.risk_level || "Warning"}
                // </Badge>

                <span
                    className={`rounded-full px-2 py-0.5 text-md font-medium ${severityColor(row?.severity)} `} >
                    {safeText(row?.severity) || "N/A"}
                </span>
            ),
        },
        {
            key: "created_at", title: "Created",
            render: (row: any) => (
                <span>{formatDate(row.created_at, DATE_FORMAT?.FULL_DAY_MONTH_YEAR)}</span>
            ),
        },
        {
            key: "View", title: "View",
            render: (row: any) => (
                <button className="shadow-theme-xs inline-flex h-8 w-8 items-center justify-center rounded-lg border border-blue-300 text-blue-500 hover:bg-blue-100 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-white/[0.03] dark:hover:text-gray-200" onClick={() => {
                    if (row?.solution) {
                        console.log("Clicked Row üëâ", row); // üëà click ‡™∏‡™Æ‡™Ø‡´á ‡™™‡™£ log
                        openModal(row);
                    }
                }}>
                    <GoEye size={16} />
                </button>
            ),
        },
    ];

    const [page, setPage] = useState(1);
    const [perPage, setPerPage] = useState(15);
    const [selectedDomain, setSelectedDomain] = useState("");

    // Filter data based on selected domain
    const filteredData = selectedDomain
        ? vulnerability.filter((item: any) => item.target_url === selectedDomain)
        : vulnerability;

    // Calculate paginated data
    const startIndex = (page - 1) * perPage;
    const currentData = filteredData.slice(startIndex, startIndex + perPage).map((item: any, index: number) => ({
        ...item,
        displayId: startIndex + index + 1
    }));

    useEffect(() => {
        setVulnerability(resVulnerabilityList);
    }, [resVulnerabilityList]);

    // Handle domain change
    const handleDomainChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
        setSelectedDomain(e.target.value);
        setPage(1); // Reset to first page on filter change
    };

    return (<>
        {/* <div className="mb-4 flex items-center gap-2">
            <div className="w-full max-w-xs">
                <label className="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300">
                    Filter by Domain
                </label>
                <div className="relative">
                    <select
                        value={selectedDomain}
                        onChange={handleDomainChange}
                        className="cursor-pointer w-full appearance-none rounded-lg border border-gray-300 bg-white px-4 py-2.5 pr-11 text-sm text-gray-800 shadow-theme-xs focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:focus:border-brand-800"
                    >
                        <option value="">All Domains</option>
                        {resDomainList?.map((domain: any) => (
                            <option key={domain.id} value={domain.domain}>
                                {domain.domain}
                            </option>
                        ))}
                    </select>
                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                        <svg className="h-4 w-4 fill-current" viewBox="0 0 20 20">
                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div> */}

        <DynamicTable columns={columns} data={currentData} />

        {/* Pagination Info & Controls */}
        <div className="mt-4 flex flex-col items-center justify-between gap-4 md:flex-row">
            <div className="text-sm text-gray-500 dark:text-gray-400">
                Showing {filteredData.length > 0 ? startIndex + 1 : 0} to{" "}
                {Math.min(startIndex + perPage, filteredData.length)} of {filteredData.length} entries
            </div>

            <Pagination
                currentPage={page}
                perPage={perPage}
                totalCount={filteredData.length}
                onChange={(newPage, newPerPage) => {
                    setPage(newPage);
                    setPerPage(newPerPage);
                }}
            />
        </div>

        <Modal isOpen={isOpen} onClose={closeModal} className="max-w-[800px] m-4">
            <div className="relative w-full max-w-[800px] overflow-y-auto rounded-3xl bg-white p-6 dark:bg-gray-900 lg:p-10">

                {/* HEADER */}
                <div className="mb-6">
                    <h4 className="text-2xl font-semibold text-gray-900 dark:text-white/90">
                        üîê Vulnerability Solution Guide
                    </h4>
                    <p className="mt-2 text-sm text-gray-700 dark:text-gray-400">
                        Below are the detected security vulnerabilities along with recommended fixes.
                    </p>
                </div>

                {/* SCROLL AREA */}
                <div className="max-h-[500px] overflow-y-auto pr-2 space-y-6">

                    {/* Vulnerability Card */}
                    <div className={`rounded-xl border p-5 ${severityColor(modalData?.severity)} bg-opacity-10 border-opacity-30`}>
                        <div className="flex justify-between items-center">
                            <h5 className="text-lg font-semibold">
                                {safeText(modalData?.type) || "Vulnerability Details"}
                            </h5>
                            <Badge color={modalData?.severity}>{safeText(modalData?.severity) || "Unknown Risk"}</Badge>
                        </div>

                        <p className="mt-3 text-sm text-gray-700 dark:text-gray-300">
                            {safeText(modalData?.detail) || safeText(modalData?.key) || "No details available."}
                        </p>

                        {/* Impact */}
                        {modalData?.impact && (
                            <div className="mt-4">
                                <h6 className="font-medium text-gray-900 dark:text-white/90">
                                    ‚ö†Ô∏è Impact
                                </h6>
                                <p className="text-sm text-gray-700 dark:text-gray-400">
                                    {safeText(modalData?.impact)}
                                </p>
                            </div>
                        )}

                        {/* Solution */}
                        <div className="mt-4">
                            <h6 className="font-medium text-gray-900 dark:text-white/90">
                                ‚úÖ Recommended Solution
                            </h6>
                            {/* Check if solution is an array or string */}
                            {Array.isArray(modalData?.solution) ? (
                                <ul className="mt-2 list-disc pl-5 text-sm text-gray-700 dark:text-gray-400 space-y-1">
                                    {modalData?.solution.map((sol: any, index: number) => (
                                        <li key={index}>{safeText(sol)}</li>
                                    ))}
                                </ul>
                            ) : (
                                <p className="mt-2 text-sm text-gray-700 dark:text-gray-400">
                                    {safeText(modalData?.solution) || "No specific solution provided."}
                                </p>
                            )}
                        </div>

                        {/* Code Example */}
                        {modalData?.codeExample && (
                            <div className="mt-4 rounded-lg bg-gray-900 p-4 text-xs text-green-400 overflow-x-auto">
                                <pre>{modalData?.codeExample}</pre>
                            </div>
                        )}

                        {/* Evidence */}
                        {modalData?.evidence && (
                            <div className="mt-4 rounded-lg bg-gray-100 p-4 text-xs text-gray-700 overflow-x-auto dark:bg-gray-800 dark:text-gray-300">
                                <strong>Evidence:</strong> {safeText(modalData?.evidence)}
                            </div>
                        )}
                    </div>

                </div>
            </div>
        </Modal>

    </>);
}
